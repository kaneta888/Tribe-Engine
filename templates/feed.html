{% extends 'base.html' %}

{% block title %}ãƒ•ã‚£ãƒ¼ãƒ‰ - Antigravity{% endblock %}

{% block content %}
<div style="max-width: 700px; margin: 0 auto;">

    <!-- Create Post Section -->
    <div class="glass-panel" style="padding: 24px; margin-bottom: 30px;">
        <form method="POST" action="{{ url_for('feed.create_post') }}" enctype="multipart/form-data">
            <textarea name="content" placeholder="ä»Šã€ä½•ã‚’è€ƒãˆã¦ã„ã¾ã™ã‹ï¼Ÿ" rows="3" style="resize: vertical;" required></textarea>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <label class="btn glass-panel"
                        style="display: inline-block; cursor: pointer; padding: 8px 16px; font-size: 0.9rem;">
                        <span>ğŸ“· ç”»åƒ</span>
                        <input type="file" name="image" accept="image/*" style="display: none;">
                    </label>

                    {% if current_user.is_admin() or current_user.is_paid_user() %}
                    <select name="visibility" style="width: auto; margin-bottom: 0; padding: 8px;">
                        <option value="all">å…¨å“¡ã«å…¬é–‹</option>
                        <option value="paid">æœ‰æ–™ä¼šå“¡ã®ã¿</option>
                    </select>
                    {% endif %}
                </div>

                <button type="submit" class="btn btn-primary">æŠ•ç¨¿ã™ã‚‹</button>
            </div>
        </form>
    </div>

    <!-- Feed Stream -->
    <div class="feed-stream">
        {% for post in posts %}
        <div id="post-{{ post.id }}" class="glass-panel"
            style="padding: 24px; margin-bottom: 24px; animation: fadeIn 0.5s ease;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="font-weight: 600;">{{ post.author.username }}</div>
                    {% if post.author.role == 'owner' %}
                    <span
                        style="background: var(--accent); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem;">ã‚ªãƒ¼ãƒŠãƒ¼</span>
                    {% elif post.author.role == 'admin' %}
                    <span
                        style="background: #e74c3c; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem;">ç®¡ç†è€…</span>
                    {% elif post.author.role == 'paid' %}
                    <span
                        style="background: #f1c40f; color: black; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem;">PRO</span>
                    {% endif %}
                </div>
                <div style="font-size: 0.8rem; color: var(--text-muted);">
                    {{ post.created_at.strftime('%Y-%m-%d %H:%M') }}
                    {% if post.visibility == 'paid' %}
                    <span style="margin-left: 8px;">ğŸ”’ é™å®šå…¬é–‹</span>
                    {% endif %}
                </div>
            </div>

            <div style="margin-bottom: 16px; white-space: pre-wrap;">{{ post.content }}</div>

            {% if post.image_path %}
            <div style="margin-bottom: 16px; border-radius: var(--radius-m); overflow: hidden;">
                <img src="{{ url_for('static', filename=post.image_path) }}" alt="Post Image"
                    style="width: 100%; display: block;">
            </div>
            {% endif %}
            <div
                style="border-top: 1px solid var(--border-color); padding-top: 12px; display: flex; flex-direction: column; gap: 15px;">
                <!-- Actions -->
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; gap: 20px; align-items: center;">
                        <!-- Like Button -->
                        <form action="{{ url_for('feed.toggle_like', post_id=post.id) }}" method="POST"
                            style="margin: 0;">
                            <button type="submit"
                                style="background: none; border: none; cursor: pointer; display: flex; align-items: center; gap: 6px; color: {{ '#e74c3c' if post.is_liked_by(current_user) else 'var(--text-color)' }}; transition: transform 0.1s;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="{{ 'currentColor' if post.is_liked_by(current_user) else 'none' }}"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path
                                        d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z">
                                    </path>
                                </svg>
                                <span style="font-size: 1rem; font-weight: 500;">{{ post.like_count }}</span>
                            </button>
                        </form>

                        <!-- Comment Button -->
                        <button onclick="toggleComments({{ post.id }})"
                            style="background: none; border: none; cursor: pointer; display: flex; align-items: center; gap: 6px; color: var(--text-color); transition: opacity 0.2s;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path
                                    d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z">
                                </path>
                            </svg>
                            <span style="font-size: 1rem; font-weight: 500;">{{ post.comments|length }}</span>
                        </button>
                    </div>

                    <div style="display: flex; gap: 20px; align-items: center;">
                        <!-- Save Button -->
                        <form action="{{ url_for('feed.toggle_save', post_id=post.id) }}" method="POST"
                            style="margin: 0;">
                            <button type="submit"
                                style="background: none; border: none; cursor: pointer; display: flex; align-items: center; color: {{ 'var(--accent)' if post.is_saved_by(current_user) else 'var(--text-muted)' }};">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="{{ 'currentColor' if post.is_saved_by(current_user) else 'none' }}"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                                </svg>
                            </button>
                        </form>

                        <!-- Delete Button (Admin/Owner only) -->
                        {% if current_user.is_admin() or current_user.id == post.author_id %}
                        <form action="{{ url_for('feed.delete_post', post_id=post.id) }}" method="POST"
                            style="margin: 0;">
                            <button type="submit"
                                style="background: none; border: none; cursor: pointer; color: var(--text-muted); opacity: 0.7;"
                                onclick="return confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path
                                        d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                    </path>
                                </svg>
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>

                <!-- Comment Section (Hidden by default) -->
                <div id="comments-{{ post.id }}"
                    style="display: none; background: rgba(0,0,0,0.2); padding: 15px; border-radius: var(--radius-m);">
                    {% for comment in post.comments %}
                    <div
                        style="margin-bottom: 10px; font-size: 0.9rem; border-bottom: 1px solid var(--border-color); padding-bottom: 5px;">
                        <strong style="color: var(--accent);">{{ comment.author.username }}</strong>: {{ comment.content
                        }}
                    </div>
                    {% endfor %}

                    <form action="{{ url_for('feed.add_comment', post_id=post.id) }}" method="POST"
                        style="margin-top: 10px; display: flex; gap: 10px;">
                        <input type="text" name="content" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã..." required style="margin-bottom: 0;">
                        <button type="submit" class="btn btn-primary" style="padding: 0 15px;">é€ä¿¡</button>
                    </form>
                </div>
            </div>
        </div>
        {% else %}
        <div style="text-align: center; color: var(--text-muted); padding: 50px;">
            ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã®æŠ•ç¨¿ã‚’ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼
        </div>
        {% endfor %}
    </div>
</div>

<style>
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<script>
    function toggleComments(postId) {
        const el = document.getElementById('comments-' + postId);
        if (el.style.display === 'none') {
            el.style.display = 'block';
        } else {
            el.style.display = 'none';
        }
    }
</script>
{% endblock %}